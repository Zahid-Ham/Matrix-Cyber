"use client";

// --- Imports ---
import { useState, useEffect } from 'react';
import { useParams, useRouter } from 'next/navigation';
import {
  ShieldAlert, DollarSign, Activity, TrendingUp,
  Clock, CheckCircle2, AlertTriangle, ArrowLeft,
  Download, Share2, Info, X, Sparkles, Loader2
} from 'lucide-react';
import { api } from '@/lib/matrix_api';
import Link from 'next/link';
import {
  BarChart, Bar, XAxis, YAxis, CartesianGrid,
  Tooltip, ResponsiveContainer, Cell
} from 'recharts';
import { AnimatePresence, motion } from 'framer-motion';
import ReactMarkdown from 'react-markdown';

// --- Types ---
// ... (Keep existing types)
interface Valuation {
  min: number;
  max: number;
  avg: number;
  confidence: number;
  strategy?: string;
}

interface ExploitBreakdown {
  basePrice: number;
  severityMultiplier: number;
  industryMultiplier: number;
  scaleMultiplier: number;
  complexityMultiplier: number;
  cvssBonus: number;
}

interface FinancialImpact {
  minTotal: number;
  maxTotal: number;
  avgTotal: number;
  breakdown: {
    baseBreach: number;
    downtime: number;
    dataBreach: number;
    fines: number;
    additional: number;
    indirect: number;
  };
}

interface ROIAnalysis {
  fixCost: number;
  fixHours: number;
  exploitValue: number;
  potentialDamage: number;
  roi: string;
}

interface MarketContext {
  similarExploits: { name: string; price: number }[];
  typicalBuyers: string[];
  marketTrend: string;
}

interface AttackStep {
  step: string;
  phase: string;
  description: string;
}

interface Equivalent {
  item: string;
  count: number;
  icon: string;
}

interface VulnerabilityDetails {
  vulnerabilityId: number;
  scanId: number;
  exploitValue: Valuation;
  exploitBreakdown: ExploitBreakdown;
  financialImpact: FinancialImpact;
  roiAnalysis: ROIAnalysis;
  marketContext: MarketContext; // Dynamic
  attackPath: AttackStep[];    // Dynamic
  equivalents: Equivalent[];   // Dynamic
  title?: string;
  severity?: string;
  cvss?: number;
  status?: string;
}

// --- Components ---

const Badge = ({ children, className, variant = 'default' }: { children: React.ReactNode, className?: string, variant?: 'critical' | 'high' | 'medium' | 'low' | 'fixed' | 'default' }) => {
  // Updated to use theme-aware classes
  const variants = {
    critical: "severity-critical",
    high: "severity-high",
    medium: "severity-medium",
    low: "severity-low",
    fixed: "bg-green-100 text-green-700 border-green-200",
    default: "bg-warm-200 text-text-secondary border-warm-300",
  };

  return (
    <span className={`px-2 py-1 rounded-full text-xs font-semibold border ${variants[variant]} ${className}`}>
      {children}
    </span>
  );
};

const Card = ({ children, className }: { children: React.ReactNode, className?: string }) => (
  // Use glass-card class from globals.css
  <div className={`glass-card p-6 ${className}`}>
    {children}
  </div>
);

const ProgressBar = ({ value, label }: { value: number, label: string }) => (
  <div className="w-full">
    <div className="flex justify-between text-xs mb-1 text-text-muted font-medium">
      <span>{label}</span>
      <span>{value}%</span>
    </div>
    <div className="h-2 bg-warm-200 rounded-full overflow-hidden">
      <div
        className="h-full bg-gradient-to-r from-emerald-600 to-emerald-400"
        style={{ width: `${value}%` }}
      />
    </div>
  </div>
);

const formatCurrency = (amount: number | undefined | null) => {
  if (amount === undefined || amount === null || isNaN(amount)) return "$0";
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
    maximumFractionDigits: 0,
    notation: amount > 1000000 ? 'compact' : 'standard'
  }).format(amount);
};

// --- Internal Helper for PDF ---
import { pdf } from '@react-pdf/renderer';
import PDFReport from '@/components/PDFReport';

// --- Main Page Component ---

export default function VulnerabilityMarketplaceDetail() {
  const params = useParams();
  const router = useRouter();
  const [data, setData] = useState<VulnerabilityDetails | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [explanation, setExplanation] = useState<string | null>(null);
  const [explaining, setExplaining] = useState(false);
  const [showExplainModal, setShowExplainModal] = useState(false);

  useEffect(() => {
    const fetchData = async () => {
      try {
        setLoading(true);
        setError(null);

        // Robust ID parsing: handle trailing slashes and malformed input
        const idStr = params.id?.toString().replace(/\/$/, '') || '';
        const idNum = Number(idStr);

        if (isNaN(idNum)) {
          throw new Error("Invalid vulnerability identifier format.");
        }

        const data = await api.getMarketplaceDetails(idNum);
        console.log("Details Data:", data);
        setData(data);
      } catch (err: any) {
        console.error("Failed to fetch details", err);
        setError(err.message || "Failed to synchronize with live market intelligence. Please ensure the analysis is complete.");
      } finally {
        setLoading(false);
      }
    };

    if (params.id) {
      fetchData();
    }
  }, [params.id]);

  const handleExplain = async () => {
    try {
      setExplaining(true);
      setShowExplainModal(true);
      const idStr = params.id?.toString().replace(/\/$/, '') || '';
      const response = await api.getMarketplaceExplanation(Number(idStr));
      setExplanation(response.explanation);
    } catch (err) {
      console.error("Failed to get explanation", err);
      setExplanation("I'm sorry, I couldn't translate the security data into a summary right now. Please try again in a few moments.");
    } finally {
      setExplaining(false);
    }
  };

  const handleExportReport = async () => {
    if (!data) return;
    try {
      // Construct a mock Scan object to satisfy the PDFReport props
      const mockScan: any = {
        id: 0,
        target_url: 'N/A',
        scan_type: 'Single Vulnerability Export',
        status: 'completed',
        progress: 100,
        total_vulnerabilities: 1,
        critical_count: data.severity === 'critical' ? 1 : 0,
        high_count: data.severity === 'high' ? 1 : 0,
        medium_count: data.severity === 'medium' ? 1 : 0,
        low_count: data.severity === 'low' ? 1 : 0,
        info_count: 0,
        technology_stack: [],
        agents_enabled: [],
        enable_waf_evasion: false,
        waf_evasion_consent: false,
        custom_headers: null,
        custom_cookies: null,
        created_at: new Date().toISOString()
      };

      const mockVuln: any = {
        id: data.vulnerabilityId,
        title: data.title || 'Untitled',
        severity: data.severity || 'medium',
        vulnerability_type: 'Exploit Analysis',
        cvss_score: data.cvss,
        url: 'N/A',
        method: 'N/A',
        description: `Market Value: ${formatCurrency(data.exploitValue.avg)} | ROI: ${data.roiAnalysis.roi}`,
        evidence: JSON.stringify(data.marketContext, null, 2), // Embed context as evidence
        ai_confidence: data.exploitValue.confidence / 100,
        reference_links: [],
        is_false_positive: false,
        is_verified: true,
        is_fixed: false,
        is_suppressed: false,
        action_required: true,
        detection_confidence: 1,
        exploit_confidence: data.exploitValue.confidence / 100,
        detected_at: new Date().toISOString(),
        scan_id: 0
      };

      const blob = await pdf(<PDFReport scan={mockScan} findings={[mockVuln]} />).toBlob();
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `market_analysis_${data.vulnerabilityId}.pdf`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    } catch (e) {
      console.error("PDF Export failed:", e);
      alert("Failed to generate report.");
    }
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-bg-primary flex flex-col items-center justify-center p-6 bg-matrix-pattern">
        <div className="glass-card p-12 max-w-lg w-full border-t-4 border-accent-primary/50 relative overflow-hidden">
          <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-accent-primary to-transparent animate-scan-fast" />

          <div className="flex items-center justify-center mb-8">
            <div className="relative">
              <div className="w-16 h-16 rounded-full border-2 border-accent-primary/30 flex items-center justify-center animate-spin-slow">
                <ShieldAlert className="w-8 h-8 text-accent-primary" />
              </div>
              <div className="absolute -inset-2 border border-accent-primary/10 rounded-full animate-ping-slow" />
            </div>
          </div>

          <div className="space-y-4 font-mono text-sm">
            <div className="flex items-center gap-3 text-text-primary">
              <span className="text-accent-primary">➜</span>
              <span className="animate-typing overflow-hidden whitespace-nowrap">Establishing secure downlink...</span>
            </div>
            <div className="flex items-center gap-3 text-text-secondary delay-150 duration-500 animate-fade-in-up">
              <span className="text-green-500">✓</span>
              <span>Querying dark web marketplaces...</span>
            </div>
            <div className="flex items-center gap-3 text-text-secondary delay-300 duration-500 animate-fade-in-up">
              <span className="text-green-500">✓</span>
              <span>Correlating exploit vectors...</span>
            </div>
            <div className="flex items-center gap-3 text-text-secondary delay-500 duration-500 animate-fade-in-up">
              <Loader2 className="w-4 h-4 animate-spin text-accent-primary" />
              <span>Calculating financial impact models...</span>
            </div>
          </div>
        </div>
        <p className="mt-6 text-text-muted font-serif-display text-sm tracking-widest uppercase">Matrix Intelligence Grid</p>
      </div>
    );
  }

  if (error || !data) {
    return (
      <div className="min-h-screen bg-bg-primary flex flex-col items-center justify-center p-6">
        <ShieldAlert className="w-16 h-16 text-red-500 mb-4" />
        <h2 className="text-2xl font-serif-display text-text-primary mb-2">Market Analysis Unavailable</h2>
        <p className="text-text-muted mb-6 text-center max-w-md">{error}</p>
        <button
          onClick={() => router.back()}
          className="px-6 py-2 bg-text-primary text-bg-primary rounded-lg font-medium hover:opacity-90 transition-opacity"
        >
          Return to Dashboard
        </button>
      </div>
    );
  }

  // Prep chart data safely
  const breakdown = data.financialImpact?.breakdown || { baseBreach: 0, downtime: 0, dataBreach: 0, fines: 0 };
  const impactChartData = [
    { name: 'Base', value: breakdown.baseBreach, fill: '#3b82f6' },
    { name: 'Downtime', value: breakdown.downtime, fill: '#ef4444' },
    { name: 'Data', value: breakdown.dataBreach, fill: '#f59e0b' },
    { name: 'Fines', value: breakdown.fines, fill: '#8b5cf6' },
  ];

  return (
    <div className="min-h-screen bg-bg-primary text-text-primary font-sans selection:bg-accent-primary selection:text-white pb-20">

      {/* Navbar Placeholder - Replace with actual Navbar component if available globally */}
      <div className="sticky top-0 z-50 bg-bg-primary/80 backdrop-blur-md border-b border-warm-200 px-6 py-4 flex justify-between items-center">
        <div className="flex items-center gap-4">
          <button onClick={() => router.back()} className="p-2 hover:bg-warm-100 rounded-full transition-colors text-text-muted hover:text-text-primary">
            <ArrowLeft className="w-5 h-5" />
          </button>
          <div className="flex items-center gap-2">
            <ShieldAlert className="w-6 h-6 text-accent-primary" />
            <span className="font-serif-display font-bold text-xl tracking-tight">Vulnerability Market</span>
          </div>
        </div>
        <div className="flex items-center gap-3">
          <button
            onClick={handleExplain}
            disabled={explaining}
            className="flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-accent-primary rounded-lg hover:brightness-110 transition-all shadow-lg shadow-accent-primary/20"
            title="Get AI Explanation"
          >
            {explaining ? (
              <div className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin" />
            ) : (
              <Sparkles className="w-4 h-4" />
            )}
            Explain This
          </button>

          <button
            onClick={handleExportReport}
            className="flex items-center gap-2 px-4 py-2 text-sm font-medium text-text-primary bg-bg-secondary border border-warm-200 rounded-lg hover:bg-warm-100 transition-colors"
            title="Download Analysis Report"
          >
            <Download className="w-4 h-4" /> Export Report
          </button>
          <button className="p-2 text-text-muted hover:text-text-primary transition-colors">
            <Share2 className="w-5 h-5" />
          </button>
        </div>
      </div>

      <main className="max-w-7xl mx-auto px-6 py-8">

        {/* Header Section */}
        <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 mb-12">
          <div>
            <div className="flex items-center gap-3 mb-2">
              <Badge variant={data.severity as any}>{data.severity?.toUpperCase() || 'UNKNOWN'}</Badge>
              <span className="text-xs font-mono text-text-muted uppercase tracking-widest">CVE-2024-PENDING</span>
            </div>
            <h1 className="text-4xl md:text-5xl font-serif-display font-medium text-text-primary leading-tight mb-4">
              {data.title || "Unknown Vulnerability"}
            </h1>
            <div className="flex items-center gap-6 text-sm text-text-muted">
              <span className="flex items-center gap-2">
                <Clock className="w-4 h-4" /> Detected 2h ago
              </span>
              <span className="flex items-center gap-2">
                <Activity className="w-4 h-4" /> Active Exploitation
              </span>
            </div>
          </div>

          <div className="flex gap-3">
            <div className="text-right">
              <div className="text-sm text-text-muted uppercase tracking-wider font-bold mb-1">Current Highest Bid</div>
              <div className="text-3xl font-serif-display font-bold text-accent-primary">{formatCurrency(data.exploitValue?.avg)}</div>
            </div>
          </div>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">

          {/* LEFT COLUMN: Valuation & Specs */}
          <div className="space-y-8">

            {/* A. Marketplace Valuation Card */}
            <Card className="relative overflow-hidden group">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-lg font-serif-display font-medium text-text-primary flex items-center gap-2">
                  <DollarSign className="w-5 h-5 text-accent-primary" /> Dark Web Market Value
                </h3>
                <span className="bg-red-100 text-red-700 text-xs px-2 py-1 rounded border border-red-200 font-medium">High Demand</span>
              </div>

              <div className="mb-6">
                <div className="text-text-muted text-sm mb-1 uppercase tracking-wider font-bold">Estimated Value Range</div>
                <div className="flex items-baseline gap-2">
                  <span className="text-sm text-text-muted">{formatCurrency(data.exploitValue?.min)}</span>
                  <span className="text-4xl font-bold text-text-primary tracking-tight font-serif-display">{formatCurrency(data.exploitValue?.avg)}</span>
                  <span className="text-sm text-text-muted">- {formatCurrency(data.exploitValue?.max)}</span>
                </div>
              </div>

              <div className="mb-6">
                <ProgressBar value={data.exploitValue?.confidence || 0} label={`Confidence Score (${data.exploitValue?.strategy || "Estimated"})`} />
              </div>

              {/* Calculation Logic Card */}
              <div className="bg-bg-secondary rounded-xl p-4 text-sm space-y-2 border border-warm-200">
                <div className="font-bold text-text-secondary mb-2 uppercase tracking-wide text-xs">Calculation Logic</div>
                <div className="flex justify-between border-b border-warm-200 pb-2">
                  <span className="text-text-muted">Base Market Value</span>
                  <span className="font-mono text-text-primary">{formatCurrency(data.exploitBreakdown?.basePrice || 0)}</span>
                </div>
                <div className="flex justify-between text-red-600 font-medium">
                  {/* Correctly accessing data.severity directly now that we've updated the interface */}
                  <span>× Severity ({data.severity})</span>
                  <span>{data.exploitBreakdown?.severityMultiplier || "1.0"}x</span>
                </div>
                <div className="flex justify-between text-blue-600 font-medium">
                  <span>× Industry (Context)</span>
                  <span>{data.exploitBreakdown?.industryMultiplier || "1.0"}x</span>
                </div>
                <div className="flex justify-between text-amber-600 font-medium">
                  <span>× Complexity</span>
                  <span>{data.exploitBreakdown?.complexityMultiplier || "1.0"}x</span>
                </div>
                <div className="flex justify-between text-purple-600 font-medium border-t border-warm-200 pt-2 mt-2">
                  <span>+ CVSS Bonus ({data.cvss || "N/A"})</span>
                  <span>+{data.exploitBreakdown?.cvssBonus || "0"}%</span>
                </div>
              </div>
            </Card>

            {/* B. Market Context (Dynamic) */}
            <Card>
              <div className="flex items-center gap-2 mb-6">
                <TrendingUp className="w-5 h-5 text-text-muted" />
                <h3 className="text-lg font-serif-display font-medium">Market Context</h3>
              </div>

              <div className="space-y-6">
                <div>
                  <div className="text-xs font-bold text-text-muted uppercase tracking-widest mb-3">Similar Exploits Recently Sold</div>
                  <div className="space-y-3">
                    {data.marketContext?.similarExploits?.map((exploit, idx) => (
                      <div key={idx} className="flex justify-between items-center text-sm pb-2 border-b border-warm-100 last:border-0">
                        <span className="text-text-primary font-medium">{exploit.name}</span>
                        <span className="font-mono text-text-muted">{formatCurrency(exploit.price)}</span>
                      </div>
                    )) || <div className="text-sm text-text-muted italic">No recent sales data available.</div>}
                  </div>
                </div>

                <div>
                  <div className="text-xs font-bold text-text-muted uppercase tracking-widest mb-3">Typical Buyers</div>
                  <div className="flex flex-wrap gap-2">
                    {data.marketContext?.typicalBuyers?.map((buyer, idx) => (
                      <span key={idx} className="px-2 py-1 bg-warm-100 text-text-secondary text-xs rounded font-medium border border-warm-200">
                        {buyer}
                      </span>
                    )) || <span className="text-sm text-text-muted italic">Unknown buyer profile.</span>}
                  </div>
                </div>

                <div className="pt-4 border-t border-warm-200">
                  <div className="flex justify-between items-center">
                    <span className="text-sm text-text-muted">Market Trend</span>
                    <span className={`text-sm font-bold flex items-center gap-1 ${data.marketContext?.marketTrend === 'Increasing' ? 'text-red-600' : 'text-text-primary'}`}>
                      {data.marketContext?.marketTrend === 'Increasing' ? <TrendingUp className="w-4 h-4" /> : <Activity className="w-4 h-4" />}
                      {data.marketContext?.marketTrend || "Stable"}
                    </span>
                  </div>
                </div>
              </div>
            </Card>

          </div>

          {/* MIDDLE COLUMN: Impact Analysis */}
          <div className="space-y-8">
            {/* Financial Impact Card */}
            <Card className="h-full border-t-4 border-t-red-500">
              <div className="mb-6">
                <h3 className="text-lg font-serif-display font-medium text-text-primary mb-1">Potential Breach Impact</h3>
                <p className="text-sm text-text-muted">Estimated financial loss if exploited.</p>
              </div>

              <div className="mb-8 text-center py-8 bg-red-50 rounded-xl border border-red-100">
                <span className="block text-sm text-red-600 font-bold uppercase tracking-widest mb-2">Total Estimated Liability</span>
                <span className="text-5xl font-serif-display font-bold text-red-900">{formatCurrency(data.financialImpact?.avgTotal)}</span>
              </div>

              <div className="space-y-6">
                {/* Breakdown Bars */}
                <div className="space-y-2">
                  <div className="flex justify-between text-sm">
                    <div className="flex items-center gap-2">
                      <span className="w-3 h-3 rounded-full bg-blue-500"></span>
                      <span className="font-medium text-text-primary">Data Breach Costs</span>
                    </div>
                    <span className="font-mono text-text-muted">{formatCurrency(data.financialImpact?.breakdown.dataBreach)}</span>
                  </div>
                  <div className="h-2 w-full bg-warm-100 rounded-full overflow-hidden">
                    <div className="h-full bg-blue-500" style={{ width: '45%' }}></div>
                  </div>
                </div>

                <div className="space-y-2">
                  <div className="flex justify-between text-sm">
                    <div className="flex items-center gap-2">
                      <span className="w-3 h-3 rounded-full bg-amber-500"></span>
                      <span className="font-medium text-text-primary">Regulatory Fines</span>
                    </div>
                    <span className="font-mono text-text-muted">{formatCurrency(data.financialImpact?.breakdown.fines)}</span>
                  </div>
                  <div className="h-2 w-full bg-warm-100 rounded-full overflow-hidden">
                    <div className="h-full bg-amber-500" style={{ width: '30%' }}></div>
                  </div>
                </div>

                {/* Dynamic Breakdown List */}
                <div className="mt-8 space-y-4 border-t border-warm-200 pt-6">
                  <div className="flex items-start gap-4">
                    <div className="p-2 bg-blue-100 text-blue-600 rounded-lg">
                      <DollarSign className="w-5 h-5" />
                    </div>
                    <div>
                      <h4 className="font-bold text-text-primary text-sm">Direct Costs ({formatCurrency(data.financialImpact?.breakdown.baseBreach)})</h4>
                      <p className="text-xs text-text-muted">Forensics, Notification, Legal</p>
                    </div>
                  </div>
                  <div className="flex items-start gap-4">
                    <div className="p-2 bg-amber-100 text-amber-600 rounded-lg">
                      <ShieldAlert className="w-5 h-5" />
                    </div>
                    <div>
                      <h4 className="font-bold text-text-primary text-sm">Regulatory Fines ({formatCurrency(data.financialImpact?.breakdown.fines)})</h4>
                      <p className="text-xs text-text-muted">GDPR, HIPAA Violations</p>
                    </div>
                  </div>
                  <div className="flex items-start gap-4">
                    <div className="p-2 bg-red-100 text-red-600 rounded-lg">
                      <Activity className="w-5 h-5" />
                    </div>
                    <div>
                      <h4 className="font-bold text-text-primary text-sm">Indirect Costs ({formatCurrency(data.financialImpact?.breakdown.indirect)})</h4>
                      <p className="text-xs text-text-muted">Downtime (~{data.roiAnalysis?.fixHours ? Math.round(data.roiAnalysis.fixHours * 2.5) : 0}h), Churn, Reputation</p>
                    </div>
                  </div>
                </div>
              </div>
            </Card>
          </div>

          {/* RIGHT COLUMN: Remediation & ROI */}
          <div className="space-y-8">

            {/* Remediation / ROI Card */}
            <Card className="bg-gradient-to-br from-white to-emerald-50 border-emerald-100">
              <div className="mb-6 flex justify-between items-start">
                <div>
                  <h3 className="text-lg font-serif-display font-medium text-emerald-900 mb-1">Remediation ROI</h3>
                  <p className="text-sm text-emerald-700">Investment vs. Risk</p>
                </div>
                <div className="p-2 bg-emerald-100 rounded-full text-emerald-600">
                  <TrendingUp className="w-5 h-5" />
                </div>
              </div>

              <div className="bg-white rounded-xl p-6 border border-emerald-100 shadow-sm mb-6">
                <div className="flex justify-between items-end mb-2">
                  <span className="text-xs font-bold text-text-muted uppercase tracking-widest">Estimated Fix Cost</span>
                  <span className="font-mono text-lg font-bold text-text-primary">{formatCurrency(data.roiAnalysis?.fixCost)}</span>
                </div>
                <div className="flex justify-between items-end">
                  <span className="text-xs font-bold text-text-muted uppercase tracking-widest">Developer Hours</span>
                  <span className="font-mono text-sm text-text-primary">{data.roiAnalysis?.fixHours}h</span>
                </div>
              </div>

              <div className="text-center mb-6">
                <div className="text-emerald-600 font-bold text-sm uppercase tracking-widest mb-1">Return on Investment</div>
                <div className="text-5xl font-serif-display font-bold text-emerald-800">{data.roiAnalysis?.roi}</div>
                <div className="text-xs text-emerald-700 mt-2 font-medium">
                  Spend {formatCurrency(data.roiAnalysis?.fixCost)} to save {formatCurrency(data.roiAnalysis?.potentialDamage)} in potential losses.
                </div>
              </div>

              <div className="space-y-3">
                <Link
                  href={`/forensics/${data.scanId}`}
                  className="w-full py-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl font-bold text-sm transition-colors shadow-lg shadow-emerald-200 block text-center"
                >
                  Create GitHub Issue
                </Link>
                <Link
                  href={`/forensics/${data.scanId}`}
                  className="w-full py-3 bg-white border border-emerald-200 text-emerald-700 hover:bg-emerald-50 rounded-xl font-bold text-sm transition-colors block text-center"
                >
                  Generate Fix PR
                </Link>
              </div>
            </Card>

            {/* Attack Path Card (Dynamic) */}
            <Card>
              <div className="mb-6">
                <h3 className="text-lg font-serif-display font-medium text-text-primary">Attack Path</h3>
              </div>

              <div className="relative pl-4 border-l-2 border-warm-200 space-y-8 ml-2">
                {data.attackPath?.map((step, idx) => (
                  <div key={idx} className="relative">
                    <span className="absolute -left-[21px] top-0 w-8 h-8 rounded-full bg-bg-secondary border border-warm-200 flex items-center justify-center text-xs font-bold text-text-muted">
                      {step.step}
                    </span>
                    <div className="ml-4">
                      <h4 className="font-bold text-text-primary text-sm">{step.phase}</h4>
                      <p className="text-xs text-text-muted mt-1">{step.description}</p>
                    </div>
                  </div>
                )) || <div className="text-sm text-text-muted italic ml-4">Attack path simulation unavailable.</div>}
              </div>
            </Card>

            {/* Real-World Equivalents (Dynamic) */}
            <Card className="bg-bg-secondary/50">
              <h3 className="text-sm font-bold text-text-muted uppercase tracking-widest mb-4">Real-World Equivalents</h3>
              <div className="space-y-4">
                {data.equivalents?.map((eq, idx) => (
                  <div key={idx} className="flex items-center gap-4">
                    <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold text-xs ${eq.icon === 'CC' ? 'bg-green-100 text-green-700' :
                      eq.icon === 'MR' ? 'bg-blue-100 text-blue-700' : 'bg-orange-100 text-orange-700'
                      }`}>
                      {eq.icon}
                    </div>
                    <div>
                      <div className="text-text-muted text-xs">Eqv. to <span className="text-text-primary font-bold">{eq.count.toLocaleString()}</span> {eq.item.toLowerCase()}</div>
                    </div>
                  </div>
                )) || <div className="text-sm text-text-muted italic">No equivalent data.</div>}
              </div>
            </Card>

          </div>
        </div>

      </main>

      {/* AI Explain Modal */}
      <AnimatePresence>
        {showExplainModal && (
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm"
            onClick={() => setShowExplainModal(false)}
          >
            <motion.div
              initial={{ scale: 0.95, opacity: 0 }}
              animate={{ scale: 1, opacity: 1 }}
              exit={{ scale: 0.95, opacity: 0 }}
              className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden max-h-[85vh] flex flex-col"
              onClick={(e) => e.stopPropagation()}
            >
              <div className="p-6 border-b border-warm-100 flex justify-between items-center bg-bg-secondary/30">
                <h3 className="text-xl font-serif-display font-medium text-text-primary flex items-center gap-2">
                  <div className="w-8 h-8 rounded-full bg-accent-primary flex items-center justify-center text-white">
                    <Info className="w-5 h-5" />
                  </div>
                  Market Intelligence Brief
                </h3>
                <button
                  onClick={() => setShowExplainModal(false)}
                  className="p-2 hover:bg-warm-100 rounded-full transition-colors"
                >
                  <X className="w-5 h-5 text-text-muted" />
                </button>
              </div>

              <div className="p-8 overflow-y-auto">
                {explanation ? (
                  <div className="prose prose-sm max-w-none text-text-primary">
                    <ReactMarkdown>{explanation}</ReactMarkdown>
                  </div>
                ) : (
                  <div className="flex flex-col items-center justify-center py-12 text-center text-text-muted">
                    <div className="w-12 h-12 border-4 border-accent-primary/20 border-t-accent-primary rounded-full animate-spin mb-4" />
                    <p>Generating briefing...</p>
                    <div className="mt-4 space-y-2 w-full max-w-xs">
                      <div className="h-2 bg-warm-100 rounded animate-pulse w-full"></div>
                      <div className="h-2 bg-warm-100 rounded animate-pulse w-4/5 mx-auto"></div>
                    </div>
                  </div>
                )}
              </div>

              <div className="p-4 bg-warm-50 border-t border-warm-100 text-center">
                <button
                  onClick={() => setShowExplainModal(false)}
                  className="px-6 py-2 bg-text-primary text-white rounded-lg font-medium hover:opacity-90 transition-opacity"
                >
                  Close Briefing
                </button>
              </div>
            </motion.div>
          </motion.div>
        )}
      </AnimatePresence>

    </div>
  );
}
