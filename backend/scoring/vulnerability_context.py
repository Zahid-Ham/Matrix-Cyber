"""
Vulnerability Context - Dataclass capturing all information needed for CVSS calculation.

This replaces the old severity-banding approach with proper context-based CVSS scoring.
"""
from dataclasses import dataclass, field
from typing import List, Dict, Any, Optional
from enum import Enum


class ExploitationDifficulty(str, Enum):
    """How difficult is exploitation."""
    TRIVIAL = "trivial"      # Script kiddie level
    MODERATE = "moderate"    # Requires some skill
    DIFFICULT = "difficult"  # Requires significant expertise


class AuthenticationLevel(str, Enum):
    """Level of authentication required."""
    NONE = "none"            # No auth needed
    LOW = "low"              # Basic user account
    HIGH = "high"            # Admin/privileged account


@dataclass
class VulnerabilityContext:
    """
    All information needed to calculate CVSS v3.1 score.
    
    This dataclass captures the specific context of a detected vulnerability,
    enabling accurate CVSS calculation based on real conditions rather than
    generic severity bands.
    
    Example:
        context = VulnerabilityContext(
            vulnerability_type="sqli",
            detection_method="error_based",
            endpoint="/api/users",
            parameter="id",
            http_method="GET",
            requires_authentication=False,
            network_accessible=True,
            data_exposed=["database"],
            payload_succeeded=True
        )
        result = cvss_calculator.calculate(context)
    """
    
    # ========================================================================
    # VULNERABILITY IDENTIFICATION
    # ========================================================================
    
    vulnerability_type: str
    """Type of vulnerability: sqli, xss, ssrf, command_injection, csrf, etc."""
    
    detection_method: str = ""
    """How vulnerability was detected: error_based, time_based, boolean_blind, etc."""
    
    # ========================================================================
    # ATTACK SURFACE
    # ========================================================================
    
    endpoint: str = ""
    """The affected endpoint/URL path."""
    
    parameter: str = ""
    """The vulnerable parameter name."""
    
    http_method: str = "GET"
    """HTTP method used: GET, POST, PUT, DELETE, etc."""
    
    # ========================================================================
    # ENVIRONMENTAL CONTEXT
    # ========================================================================
    
    requires_authentication: bool = False
    """Does exploiting this vulnerability require the attacker to be authenticated?"""
    
    authentication_level: str = "none"
    """Level of auth required: none, low (user), high (admin)."""
    
    network_accessible: bool = True
    """Is the vulnerability accessible over the network? (vs local only)"""
    
    requires_local_network: bool = False
    """Does it require being on the same local network (adjacent)?"""
    
    requires_physical_access: bool = False
    """Does it require physical access to the device?"""
    
    behind_waf: bool = False
    """Is a WAF present that needed to be bypassed?"""
    
    # ========================================================================
    # EXPLOITATION CHARACTERISTICS
    # ========================================================================
    
    exploitation_difficulty: str = "moderate"
    """How difficult is exploitation: trivial, moderate, difficult."""
    
    requires_user_interaction: bool = False
    """Does a victim user need to perform an action (click, visit page)?"""
    
    requires_social_engineering: bool = False
    """Does exploitation require tricking a user?"""
    
    requires_specific_conditions: bool = False
    """Are there race conditions, timing requirements, or specific configs needed?"""
    
    # ========================================================================
    # IMPACT EVIDENCE
    # ========================================================================
    
    data_exposed: List[str] = field(default_factory=list)
    """What data can be read: database, filesystem, memory, credentials, etc."""
    
    data_modifiable: List[str] = field(default_factory=list)
    """What data can be modified: database, filesystem, configuration, etc."""
    
    service_disruption_possible: bool = False
    """Can the vulnerability cause denial of service?"""
    
    escapes_security_boundary: bool = False
    """Does impact escape the vulnerable component? (Scope:Changed)
    
    Examples of Scope:Changed:
    - SQLi that can execute OS commands
    - SSRF to cloud metadata service
    - XSS affecting different origin
    - Container escape
    """
    
    # ========================================================================
    # SCOPE CHANGE INDICATORS
    # ========================================================================
    
    can_execute_os_commands: bool = False
    """SQLi with xp_cmdshell, command injection, etc."""
    
    can_access_internal_network: bool = False
    """SSRF to internal services."""
    
    can_access_cloud_metadata: bool = False
    """SSRF to AWS/GCP/Azure metadata."""
    
    affects_other_users: bool = False
    """Stored XSS, CSRF affecting other users."""
    
    # ========================================================================
    # VALIDATION EVIDENCE
    # ========================================================================
    
    error_messages: List[str] = field(default_factory=list)
    """SQL errors, stack traces, etc. found in response."""
    
    timing_delay_observed: float = 0.0
    """Seconds of delay observed for time-based detection."""
    
    payload_succeeded: bool = False
    """Did the exploit payload successfully execute?"""
    
    response_difference_ratio: float = 0.0
    """For boolean-based: how much responses differed (0-1)."""
    
    # ========================================================================
    # TECHNICAL METADATA
    # ========================================================================
    
    target_technology: str = ""
    """Backend technology: MySQL, PostgreSQL, IIS, Apache, etc."""
    
    security_controls_bypassed: List[str] = field(default_factory=list)
    """Controls that were bypassed: waf, rate_limiting, csrf_token, etc."""
    
    additional_context: Dict[str, Any] = field(default_factory=dict)
    """Any additional context specific to the vulnerability type."""
    
    def to_dict(self) -> Dict[str, Any]:
        """Convert to dictionary for serialization."""
        return {
            "vulnerability_type": self.vulnerability_type,
            "detection_method": self.detection_method,
            "endpoint": self.endpoint,
            "parameter": self.parameter,
            "http_method": self.http_method,
            "requires_authentication": self.requires_authentication,
            "authentication_level": self.authentication_level,
            "network_accessible": self.network_accessible,
            "exploitation_difficulty": self.exploitation_difficulty,
            "requires_user_interaction": self.requires_user_interaction,
            "data_exposed": self.data_exposed,
            "data_modifiable": self.data_modifiable,
            "service_disruption_possible": self.service_disruption_possible,
            "escapes_security_boundary": self.escapes_security_boundary,
            "payload_succeeded": self.payload_succeeded,
            "target_technology": self.target_technology,
        }
