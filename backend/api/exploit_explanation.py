from fastapi import APIRouter, HTTPException, Depends
from pydantic import BaseModel
from typing import Optional
from core.groq_client import chatbot_generate

router = APIRouter(prefix="/exploit", tags=["Exploit Explanation"])

class ExplainRequest(BaseModel):
    command: str
    context: Optional[str] = "General Linux/Security Context"

class ExplainResponse(BaseModel):
    explanation: str
    breakdown: Optional[str] = None

@router.post("/explain", response_model=ExplainResponse)
async def explain_command_endpoint(request: ExplainRequest):
    """
    Explains a terminal command in simple, natural language using Groq AI.
    """
    try:
        prompt = (
            f"Explain the following command to a complete beginner (someone with NO coding experience):\n\n"
            f"Command: `{request.command}`\n"
            f"Context: {request.context}\n\n"
            f"Rules for the explanation:\n"
            f"1. Use a simple REAL-WORLD ANALOGY (e.g., 'This is like asking a receptionist for a list of names').\n"
            f"2. Avoid technical jargon where possible. If you must use a term like 'flag', explain it simply.\n"
            f"3. Explain 'WHY' we are doing this, not just 'WHAT' it does.\n"
            f"4. Keep it short, encouraging, and easy to read.\n\n"
            f"Format:\n"
            f"**Analogy:** [Insert analogy here]\n"
            f"**Simply Put:** [1 sentence explanation]\n"
            f"**The Parts:**\n"
            f"- `part`: simple explanation\n"
            f"**What You'll See:** [Simple description of output]"
        )

        response = await chatbot_generate(prompt=prompt, temperature=0.3, max_tokens=300)
        content = response.get("content", "No explanation available.")

        return ExplainResponse(explanation=content)

    except Exception as e:
        print(f"Error in explain_command: {e}")
        raise HTTPException(status_code=500, detail=str(e))

class ExplainOutputRequest(BaseModel):
    output: str
    command: Optional[str] = None
    context: str = "terminal"  # "terminal" or "browser"

@router.post("/explain-output")
async def explain_output_endpoint(req: ExplainOutputRequest):
    """
    Analyzes the output of a command or web page content to explain findings.
    """
    try:
        system_prompt = (
            "You are an expert Senior Fenetration Tester and Cybersecurity Instructor. "
            "Your goal is to explain the OUTPUT of a security tool or exploit to a student.\n\n"
            "**INSTRUCTION:** Perform a detailed, LINE-BY-LINE analysis of the provided output.\n"
            "Format your response in Markdown using the following structure:\n\n"
            "### üîç Analysis Overview\n"
            "(A brief high-level summary of what this data represents e.g., 'This is a standard /etc/passwd file dump.')\n\n"
            "### üìú Line-by-Line Breakdown\n"
            "(Go through the most important lines in the output. For each interesting line, quote it and explain clearly.)\n"
            "- **`[Quote specific line here]`** \n"
            "  -> *Explanation:* [Explain exactly what this line means. Decoding flags, permissions, or user IDs].\n\n"
            "### üõ°Ô∏è Why This Matters (Impact)\n"
            "- Explain the security implications.\n"
            "- What can an attacker do with this information?\n\n"
            "**Rules:**\n"
            "1. Do NOT be generic. Explain the *actual values* seen in the output.\n"
            "2. If the output is long, focus on the top 5 most critical lines (e.g., root user, known services).\n"
            "3. Use bolding and code blocks for readability."
        )

        user_content = f"Context: {req.context}\n"
        if req.command:
            user_content += f"Command execution: `{req.command}`\n"
        user_content += f"\nOutput/Content to Analyze:\n```\n{req.output[:4000]}\n```" # Truncate to avoid token limits

        response = await chatbot_generate(
            prompt=user_content, 
            temperature=0.7, 
            system_prompt=system_prompt
        )
        content = response.get("content", "No explanation available.")

        return {"explanation": content}

    except Exception as e:
        print(f"Error in explain_output: {e}")
        raise HTTPException(status_code=500, detail=str(e))
