from fastapi import APIRouter, HTTPException, BackgroundTasks
from pydantic import BaseModel
from typing import Dict, Optional
import time

from services.docker_service import DockerExploitService

router = APIRouter(tags=["Exploit Sandbox"])
docker_service = DockerExploitService()

class SandboxRequest(BaseModel):
    vulnerability_type: str

class CommandRequest(BaseModel):
    container_id: str
    command: str

class SandboxResponse(BaseModel):
    session_id: str
    container_id: str
    url: str
    status: str
    type: str

@router.post("/exploit/start/", response_model=SandboxResponse)
async def start_sandbox(request: SandboxRequest):
    """
    Start a new isolated training container for the given vulnerability type.
    """
    try:
        result = docker_service.start_sandbox(request.vulnerability_type)
        return SandboxResponse(**result)
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@router.post("/exploit/stop/{container_id}/")
async def stop_sandbox(container_id: str):
    """
    Stop and remove a sandbox container.
    """
    try:
        result = docker_service.stop_sandbox(container_id)
        if not result:
            raise HTTPException(status_code=404, detail="Container not found")
        return {"status": "stopped", "container_id": container_id}
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@router.post("/exploit/command/")
async def execute_command(request: CommandRequest):
    """
    Execute a shell command inside the sandbox container.
    Returns the command output.
    """
    try:
        output = docker_service.execute_command(request.container_id, request.command)
        return {"output": output}
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@router.post("/exploit/heartbeat/{container_id}/")
async def heartbeat(container_id: str):
    """
    Keep-alive signal for the sandbox container.
    """
    if docker_service.heartbeat(container_id):
        return {"status": "ok"}
    raise HTTPException(status_code=404, detail="Container not found or not active")

@router.get("/exploit/check-docker/")
async def check_docker_status():
    """
    Diagnostic endpoint to check if Docker is available on the backend.
    """
    if docker_service.client:
        try:
            version = docker_service.client.version()
            return {"status": "available", "version": version}
        except Exception as e:
            return {"status": "error", "detail": str(e)}
    else:
        return {"status": "unavailable", "detail": "Docker client could not be initialized"}
