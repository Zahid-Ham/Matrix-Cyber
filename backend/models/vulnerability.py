"""
Enhanced Vulnerability database model with CVSS v3.1, OWASP mapping, and advanced security metrics.
"""
from datetime import datetime
from enum import Enum
from typing import Dict, Optional, List, Any
import math
from sqlalchemy import (
    Column, Integer, String, Text, Float, DateTime, ForeignKey, 
    JSON, Boolean, CheckConstraint, Index, event
)
from sqlalchemy import Enum as SQLEnum
from sqlalchemy.orm import relationship, validates
from core.database import Base


# ============================================================================
# ENUMS - Enhanced with OWASP & CWE Mapping
# ============================================================================

class Severity(str, Enum):
    """Vulnerability severity levels with numeric scores and color codes."""
    CRITICAL = "critical"
    HIGH = "high"
    MEDIUM = "medium"
    LOW = "low"
    INFO = "info"
    
    @property
    def score(self) -> int:
        """Numeric score for severity (1-5)."""
        return {
            "critical": 5,
            "high": 4,
            "medium": 3,
            "low": 2,
            "info": 1
        }[self.value]
    
    @property
    def color(self) -> str:
        """Color code for UI display."""
        return {
            "critical": "#DC2626",  # Red
            "high": "#EA580C",      # Orange
            "medium": "#F59E0B",    # Amber
            "low": "#10B981",       # Green
            "info": "#3B82F6"       # Blue
        }[self.value]
    
    @property
    def cvss_range(self) -> tuple:
        """CVSS score range for this severity."""
        return {
            "critical": (9.0, 10.0),
            "high": (7.0, 8.9),
            "medium": (4.0, 6.9),
            "low": (0.1, 3.9),
            "info": (0.0, 0.0)
        }[self.value]


class VulnerabilityType(str, Enum):
    """
    Comprehensive vulnerability types mapped to OWASP Top 10 2021 and CWE.
    """
    # Injection Attacks
    SQL_INJECTION = "sql_injection"
    NOSQL_INJECTION = "nosql_injection"
    LDAP_INJECTION = "ldap_injection"
    OS_COMMAND_INJECTION = "command_injection"
    CODE_INJECTION = "code_injection"
    XML_INJECTION = "xml_injection"
    XPATH_INJECTION = "xpath_injection"
    SSTI = "server_side_template_injection"
    
    # Cross-Site Scripting
    XSS_REFLECTED = "xss_reflected"
    XSS_STORED = "xss_stored"
    XSS_DOM = "xss_dom"
    XSS_MUTATION = "xss_mutation"
    
    # Broken Authentication
    WEAK_PASSWORD = "weak_password"
    BROKEN_AUTH = "broken_authentication"
    SESSION_FIXATION = "session_fixation"
    INSUFFICIENT_SESSION_EXPIRATION = "insufficient_session_expiration"
    CREDENTIAL_STUFFING = "credential_stuffing"
    BRUTE_FORCE_VULNERABLE = "brute_force_vulnerable"
    
    # Sensitive Data Exposure
    SENSITIVE_DATA_EXPOSURE = "sensitive_data_exposure"
    PLAINTEXT_TRANSMISSION = "plaintext_transmission"
    WEAK_CRYPTO = "weak_cryptography"
    HARDCODED_CREDENTIALS = "hardcoded_credentials"
    PII_EXPOSURE = "pii_exposure"
    
    # Broken Access Control
    IDOR = "insecure_direct_object_reference"
    PATH_TRAVERSAL = "path_traversal"
    PRIVILEGE_ESCALATION = "privilege_escalation"
    MISSING_AUTHORIZATION = "missing_authorization"
    CORS_MISCONFIGURATION = "cors_misconfiguration"
    
    # Security Misconfiguration
    SECURITY_MISCONFIG = "security_misconfiguration"
    DEBUG_MODE_ENABLED = "debug_mode_enabled"
    DEFAULT_CREDENTIALS = "default_credentials"
    DIRECTORY_LISTING = "directory_listing"
    VERBOSE_ERROR_MESSAGES = "verbose_error_messages"
    MISSING_SECURITY_HEADERS = "missing_security_headers"
    
    # Vulnerable Components
    OUTDATED_COMPONENT = "outdated_component"
    VULNERABLE_DEPENDENCY = "vulnerable_dependency"
    
    # SSRF & Related
    SSRF = "server_side_request_forgery"
    OPEN_REDIRECT = "open_redirect"
    
    # CSRF & Session Issues
    CSRF = "csrf"
    CLICKJACKING = "clickjacking"
    
    # XXE & Deserialization
    XXE = "xml_external_entity"
    INSECURE_DESERIALIZATION = "insecure_deserialization"
    
    # File Handling
    UNRESTRICTED_FILE_UPLOAD = "unrestricted_file_upload"
    FILE_INCLUSION = "file_inclusion"
    
    # API Security
    API_RATE_LIMIT_MISSING = "api_rate_limit_missing"
    API_AUTH_BYPASS = "api_authentication_bypass"
    MASS_ASSIGNMENT = "mass_assignment"
    
    # Information Disclosure
    INFO_DISCLOSURE = "information_disclosure"
    SOURCE_CODE_DISCLOSURE = "source_code_disclosure"
    
    # Business Logic
    BUSINESS_LOGIC_FLAW = "business_logic_flaw"
    RACE_CONDITION = "race_condition"
    
    # Other
    OTHER = "other"
    
    @property
    def owasp_2021_category(self) -> str:
        """Map vulnerability type to OWASP Top 10 2021 category."""
        mapping = {
            # A01:2021 - Broken Access Control
            "idor": "A01:2021-Broken Access Control",
            "path_traversal": "A01:2021-Broken Access Control",
            "privilege_escalation": "A01:2021-Broken Access Control",
            "missing_authorization": "A01:2021-Broken Access Control",
            "cors_misconfiguration": "A01:2021-Broken Access Control",
            
            # A02:2021 - Cryptographic Failures
            "sensitive_data_exposure": "A02:2021-Cryptographic Failures",
            "plaintext_transmission": "A02:2021-Cryptographic Failures",
            "weak_cryptography": "A02:2021-Cryptographic Failures",
            "pii_exposure": "A02:2021-Cryptographic Failures",
            
            # A03:2021 - Injection
            "sql_injection": "A03:2021-Injection",
            "nosql_injection": "A03:2021-Injection",
            "ldap_injection": "A03:2021-Injection",
            "command_injection": "A03:2021-Injection",
            "code_injection": "A03:2021-Injection",
            "xml_injection": "A03:2021-Injection",
            "xpath_injection": "A03:2021-Injection",
            "server_side_template_injection": "A03:2021-Injection",
            "xss_reflected": "A03:2021-Injection",
            "xss_stored": "A03:2021-Injection",
            "xss_dom": "A03:2021-Injection",
            "xss_mutation": "A03:2021-Injection",
            
            # A04:2021 - Insecure Design
            "business_logic_flaw": "A04:2021-Insecure Design",
            "race_condition": "A04:2021-Insecure Design",
            
            # A05:2021 - Security Misconfiguration
            "security_misconfiguration": "A05:2021-Security Misconfiguration",
            "debug_mode_enabled": "A05:2021-Security Misconfiguration",
            "default_credentials": "A05:2021-Security Misconfiguration",
            "directory_listing": "A05:2021-Security Misconfiguration",
            "verbose_error_messages": "A05:2021-Security Misconfiguration",
            "missing_security_headers": "A05:2021-Security Misconfiguration",
            
            # A06:2021 - Vulnerable and Outdated Components
            "outdated_component": "A06:2021-Vulnerable and Outdated Components",
            "vulnerable_dependency": "A06:2021-Vulnerable and Outdated Components",
            
            # A07:2021 - Identification and Authentication Failures
            "weak_password": "A07:2021-Identification and Authentication Failures",
            "broken_authentication": "A07:2021-Identification and Authentication Failures",
            "session_fixation": "A07:2021-Identification and Authentication Failures",
            "insufficient_session_expiration": "A07:2021-Identification and Authentication Failures",
            "credential_stuffing": "A07:2021-Identification and Authentication Failures",
            "brute_force_vulnerable": "A07:2021-Identification and Authentication Failures",
            
            # A08:2021 - Software and Data Integrity Failures
            "insecure_deserialization": "A08:2021-Software and Data Integrity Failures",
            "hardcoded_credentials": "A08:2021-Software and Data Integrity Failures",
            
            # A09:2021 - Security Logging and Monitoring Failures
            # (Most would be identified in other ways)
            
            # A10:2021 - Server-Side Request Forgery
            "server_side_request_forgery": "A10:2021-Server-Side Request Forgery",
            
            # Other categories
            "csrf": "CSRF",
            "clickjacking": "Clickjacking",
            "xml_external_entity": "XXE",
            "unrestricted_file_upload": "File Upload",
            "file_inclusion": "File Inclusion",
            "api_rate_limit_missing": "API Security",
            "api_authentication_bypass": "API Security",
            "mass_assignment": "API Security",
            "open_redirect": "Open Redirect",
            "information_disclosure": "Information Disclosure",
            "source_code_disclosure": "Information Disclosure",
        }
        return mapping.get(self.value, "Other")
    
    @property
    def cwe_id(self) -> Optional[str]:
        """Map vulnerability type to CWE ID."""
        mapping = {
            "sql_injection": "CWE-89",
            "nosql_injection": "CWE-943",
            "ldap_injection": "CWE-90",
            "command_injection": "CWE-78",
            "code_injection": "CWE-94",
            "xml_injection": "CWE-91",
            "xpath_injection": "CWE-643",
            "server_side_template_injection": "CWE-94",
            "xss_reflected": "CWE-79",
            "xss_stored": "CWE-79",
            "xss_dom": "CWE-79",
            "xss_mutation": "CWE-79",
            "weak_password": "CWE-521",
            "broken_authentication": "CWE-287",
            "session_fixation": "CWE-384",
            "insufficient_session_expiration": "CWE-613",
            "credential_stuffing": "CWE-307",
            "brute_force_vulnerable": "CWE-307",
            "sensitive_data_exposure": "CWE-200",
            "plaintext_transmission": "CWE-319",
            "weak_cryptography": "CWE-326",
            "hardcoded_credentials": "CWE-798",
            "pii_exposure": "CWE-359",
            "idor": "CWE-639",
            "path_traversal": "CWE-22",
            "privilege_escalation": "CWE-269",
            "missing_authorization": "CWE-862",
            "cors_misconfiguration": "CWE-942",
            "security_misconfiguration": "CWE-16",
            "debug_mode_enabled": "CWE-489",
            "default_credentials": "CWE-798",
            "directory_listing": "CWE-548",
            "verbose_error_messages": "CWE-209",
            "missing_security_headers": "CWE-693",
            "outdated_component": "CWE-1104",
            "vulnerable_dependency": "CWE-1035",
            "server_side_request_forgery": "CWE-918",
            "open_redirect": "CWE-601",
            "csrf": "CWE-352",
            "clickjacking": "CWE-1021",
            "xml_external_entity": "CWE-611",
            "insecure_deserialization": "CWE-502",
            "unrestricted_file_upload": "CWE-434",
            "file_inclusion": "CWE-98",
            "api_rate_limit_missing": "CWE-770",
            "api_authentication_bypass": "CWE-306",
            "mass_assignment": "CWE-915",
            "information_disclosure": "CWE-200",
            "source_code_disclosure": "CWE-540",
            "business_logic_flaw": "CWE-840",
            "race_condition": "CWE-362",
        }
        return mapping.get(self.value)


class CVSSAttackVector(str, Enum):
    """CVSS v3.1 Attack Vector metric."""
    NETWORK = "N"
    ADJACENT = "A"
    LOCAL = "L"
    PHYSICAL = "P"


class CVSSAttackComplexity(str, Enum):
    """CVSS v3.1 Attack Complexity metric."""
    LOW = "L"
    HIGH = "H"


class CVSSPrivilegesRequired(str, Enum):
    """CVSS v3.1 Privileges Required metric."""
    NONE = "N"
    LOW = "L"
    HIGH = "H"


class CVSSUserInteraction(str, Enum):
    """CVSS v3.1 User Interaction metric."""
    NONE = "N"
    REQUIRED = "R"


class CVSSScope(str, Enum):
    """CVSS v3.1 Scope metric."""
    UNCHANGED = "U"
    CHANGED = "C"


class CVSSImpact(str, Enum):
    """CVSS v3.1 Impact metrics (Confidentiality, Integrity, Availability)."""
    NONE = "N"
    LOW = "L"
    HIGH = "H"


class VulnerabilityStatus(str, Enum):
    """Lifecycle status of a vulnerability."""
    NEW = "new"
    CONFIRMED = "confirmed"
    FALSE_POSITIVE = "false_positive"
    IN_PROGRESS = "in_progress"
    FIXED = "fixed"
    ACCEPTED_RISK = "accepted_risk"
    RETEST_REQUIRED = "retest_required"
    REOPENED = "reopened"


# ============================================================================
# VULNERABILITY MODEL
# ============================================================================

class Vulnerability(Base):
    """
    Enhanced vulnerability model with CVSS v3.1, OWASP mapping, and advanced security metrics.
    """
    
    __tablename__ = "vulnerabilities"
    
    # ========================================================================
    # PRIMARY IDENTIFICATION
    # ========================================================================
    
    id = Column(Integer, primary_key=True, index=True)
    
    # ========================================================================
    # CLASSIFICATION & SEVERITY
    # ========================================================================
    
    vulnerability_type = Column(
        SQLEnum(VulnerabilityType), 
        nullable=False,
        index=True  # Frequently queried
    )
    severity = Column(
        SQLEnum(Severity), 
        nullable=False,
        index=True  # Frequently queried for filtering
    )
    
    # ========================================================================
    # CVSS v3.1 BASE METRICS
    # ========================================================================
    
    cvss_score = Column(
        Float, 
        nullable=True,
        index=True  # For sorting by severity
    )
    cvss_vector = Column(String(100), nullable=True)  # e.g., "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H"
    
    # Base Metrics
    cvss_attack_vector = Column(SQLEnum(CVSSAttackVector), nullable=True)
    cvss_attack_complexity = Column(SQLEnum(CVSSAttackComplexity), nullable=True)
    cvss_privileges_required = Column(SQLEnum(CVSSPrivilegesRequired), nullable=True)
    cvss_user_interaction = Column(SQLEnum(CVSSUserInteraction), nullable=True)
    cvss_scope = Column(SQLEnum(CVSSScope), nullable=True)
    cvss_confidentiality = Column(SQLEnum(CVSSImpact), nullable=True)
    cvss_integrity = Column(SQLEnum(CVSSImpact), nullable=True)
    cvss_availability = Column(SQLEnum(CVSSImpact), nullable=True)
    
    # ========================================================================
    # LOCATION & CONTEXT
    # ========================================================================
    
    url = Column(String(2048), nullable=False, index=True)
    file_path = Column(String(1024), nullable=True, index=True)
    parameter = Column(String(255), nullable=True)
    method = Column(String(10), default="GET")  # GET, POST, PUT, DELETE, etc.
    endpoint = Column(String(500), nullable=True)  # Normalized endpoint pattern
    
    # ========================================================================
    # RISK ASSESSMENT
    # ========================================================================
    
    likelihood = Column(Float, default=5.0)  # 0.0 - 10.0
    impact = Column(Float, default=5.0)      # 0.0 - 10.0
    exploitability = Column(Float, default=5.0)  # 0.0 - 10.0 (ease of exploitation)
    exploitability_rationale = Column(Text, nullable=True)
    
    # ========================================================================
    # DETAILS & EVIDENCE
    # ========================================================================
    
    title = Column(String(500), nullable=False)
    description = Column(Text, nullable=False)
    evidence = Column(Text, nullable=True)  # Proof of vulnerability
    
    # Request/Response data
    request_data = Column(JSON, nullable=True)  # Full HTTP request
    response_snippet = Column(Text, nullable=True)  # Relevant response portion
    payload_used = Column(Text, nullable=True)  # Actual payload that triggered vulnerability
    
    # ========================================================================
    # AI ANALYSIS
    # ========================================================================
    
    ai_confidence = Column(Float, default=0.0)  # 0-100
    ai_analysis = Column(Text, nullable=True)
    ai_model_version = Column(String(50), nullable=True)  # e.g., "gpt-4", "claude-3"
    
    # ========================================================================
    # REMEDIATION
    # ========================================================================
    
    remediation = Column(Text, nullable=True)
    remediation_code = Column(Text, nullable=True)
    remediation_effort = Column(String(20), nullable=True)  # low, medium, high
    remediation_priority = Column(Integer, default=0)  # 1-10, calculated
    reference_links = Column(JSON, default=list)
    
    # ========================================================================
    # OWASP & CWE MAPPING
    # ========================================================================
    
    owasp_category = Column(String(100), nullable=True, index=True)
    cwe_id = Column(String(20), nullable=True, index=True)
    cwe_name = Column(String(255), nullable=True)
    
    # ========================================================================
    # STATUS & LIFECYCLE
    # ========================================================================
    
    status = Column(
        SQLEnum(VulnerabilityStatus),
        default=VulnerabilityStatus.NEW,
        nullable=False,
        index=True
    )
    
    is_false_positive = Column(Boolean, default=False, index=True)
    false_positive_reason = Column(Text, nullable=True)
    false_positive_marked_by = Column(Integer, nullable=True)  # User ID
    
    is_verified = Column(Boolean, default=False, index=True)
    verified_by = Column(Integer, nullable=True)  # User ID
    
    is_fixed = Column(Boolean, default=False, index=True)
    fix_verified = Column(Boolean, default=False)
    
    is_suppressed = Column(Boolean, default=False, index=True)
    suppression_reason = Column(Text, nullable=True)
    suppressed_until = Column(DateTime, nullable=True)
    
    # ========================================================================
    # FINAL VERDICT & ACTION
    # ========================================================================
    
    final_verdict = Column(String(50), nullable=True)
    action_required = Column(Boolean, default=True, index=True)
    detection_confidence = Column(Float, default=0.0)  # 0.0 - 1.0
    exploit_confidence = Column(Float, default=0.0)     # 0.0 - 1.0
    
    # ========================================================================
    # SCOPE & IMPACT ANALYSIS
    # ========================================================================
    
    scope_impact = Column(JSON, nullable=True)  # { "affected_endpoints": 3, "data_at_risk": ["users", "payments"] }
    affected_users = Column(Integer, default=0)  # Estimated number of affected users
    business_impact = Column(Text, nullable=True)
    compliance_impact = Column(JSON, nullable=True)  # { "GDPR": true, "PCI-DSS": false }
    
    # ========================================================================
    # DETECTION METADATA
    # ========================================================================
    
    detected_by = Column(String(100), nullable=True, index=True)  # Agent name
    detection_method = Column(String(100), nullable=True)  # passive, active, fuzzing, etc.
    scanner_version = Column(String(50), nullable=True)
    
    # ========================================================================
    # RETEST & VALIDATION
    # ========================================================================
    
    retest_status = Column(String(50), nullable=True)  # pending, passed, failed
    retest_count = Column(Integer, default=0)
    last_retest_at = Column(DateTime, nullable=True)
    
    # ========================================================================
    # TIMESTAMPS
    # ========================================================================
    
    detected_at = Column(DateTime, default=datetime.utcnow, index=True)
    verified_at = Column(DateTime, nullable=True)
    fixed_at = Column(DateTime, nullable=True)
    closed_at = Column(DateTime, nullable=True)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    
    # Soft delete support
    deleted_at = Column(DateTime, nullable=True)
    
    # ========================================================================
    # RELATIONSHIPS
    # ========================================================================
    
    scan_id = Column(Integer, ForeignKey("scans.id"), nullable=False, index=True)
    scan = relationship("Scan", back_populates="vulnerabilities")
    
    # ========================================================================
    # CONSTRAINTS & INDEXES
    # ========================================================================
    
    __table_args__ = (
        CheckConstraint('cvss_score >= 0.0 AND cvss_score <= 10.0', name='check_cvss_range'),
        CheckConstraint('likelihood >= 0.0 AND likelihood <= 10.0', name='check_likelihood_range'),
        CheckConstraint('impact >= 0.0 AND impact <= 10.0', name='check_impact_range'),
        CheckConstraint('exploitability >= 0.0 AND exploitability <= 10.0', name='check_exploitability_range'),
        CheckConstraint('ai_confidence >= 0.0 AND ai_confidence <= 100.0', name='check_ai_confidence_range'),
        CheckConstraint('detection_confidence >= 0.0 AND detection_confidence <= 1.0', name='check_detection_confidence_range'),
        CheckConstraint('exploit_confidence >= 0.0 AND exploit_confidence <= 1.0', name='check_exploit_confidence_range'),
        
        # Composite indexes for common queries
        Index('idx_vuln_scan_severity', 'scan_id', 'severity'),
        Index('idx_vuln_scan_type', 'scan_id', 'vulnerability_type'),
        Index('idx_vuln_scan_status', 'scan_id', 'status'),
        Index('idx_vuln_severity_action', 'severity', 'action_required'),
        Index('idx_vuln_owasp_category', 'owasp_category'),
        Index('idx_vuln_cwe', 'cwe_id'),
        Index('idx_vuln_detected_by', 'detected_by'),
    )
    
    # ========================================================================
    # VALIDATORS
    # ========================================================================
    
    @validates('url')
    def validate_url(self, key, url):
        """Validate URL format."""
        if not url or len(url) > 2048:
            raise ValueError("URL must be between 1 and 2048 characters")
        return url
    
    # ========================================================================
    # PROPERTIES
    # ========================================================================
    
    @property
    def is_deleted(self) -> bool:
        """Check if vulnerability is soft deleted."""
        return self.deleted_at is not None
    
    @property
    def risk_level(self) -> str:
        """
        Calculate overall risk level based on severity, likelihood, and exploitability.
        """
        risk_score = (
            self.severity.score * 0.4 +
            (self.likelihood / 2) * 0.3 +
            (self.exploitability / 2) * 0.3
        )
        
        if risk_score >= 4.5:
            return "CRITICAL"
        elif risk_score >= 3.5:
            return "HIGH"
        elif risk_score >= 2.5:
            return "MEDIUM"
        elif risk_score >= 1.5:
            return "LOW"
        else:
            return "INFO"
    
    @property
    def priority_score(self) -> int:
        """
        Calculate priority score (0-100) for triaging.
        Factors: severity, exploitability, affected users, business impact.
        """
        base_score = self.severity.score * 15  # 0-75
        exploit_score = self.exploitability * 2  # 0-20
        user_impact = min(5, math.log10(max(1, self.affected_users)))  # 0-5
        
        priority = base_score + exploit_score + user_impact
        
        # Boost for verified vulnerabilities
        if self.is_verified:
            priority *= 1.1
        
        # Reduce for false positives or suppressed
        if self.is_false_positive or self.is_suppressed:
            priority *= 0.1
        
        return min(100, int(priority))
    
    @property
    def age_days(self) -> int:
        """Days since vulnerability was detected."""
        if self.detected_at:
            return (datetime.utcnow() - self.detected_at).days
        return 0
    
    # ========================================================================
    # CVSS CALCULATION METHODS
    # ========================================================================
    
    def set_cvss_from_severity(self) -> None:
        """
        Set default CVSS metrics based on severity level.
        Useful for quickly initializing vulnerabilities.
        """
        defaults = {
            Severity.CRITICAL: {
                'attack_vector': CVSSAttackVector.NETWORK,
                'attack_complexity': CVSSAttackComplexity.LOW,
                'privileges_required': CVSSPrivilegesRequired.NONE,
                'user_interaction': CVSSUserInteraction.NONE,
                'scope': CVSSScope.CHANGED,
                'confidentiality': CVSSImpact.HIGH,
                'integrity': CVSSImpact.HIGH,
                'availability': CVSSImpact.HIGH,
            },
            Severity.HIGH: {
                'attack_vector': CVSSAttackVector.NETWORK,
                'attack_complexity': CVSSAttackComplexity.LOW,
                'privileges_required': CVSSPrivilegesRequired.LOW,
                'user_interaction': CVSSUserInteraction.NONE,
                'scope': CVSSScope.UNCHANGED,
                'confidentiality': CVSSImpact.HIGH,
                'integrity': CVSSImpact.HIGH,
                'availability': CVSSImpact.LOW,
            },
            Severity.MEDIUM: {
                'attack_vector': CVSSAttackVector.NETWORK,
                'attack_complexity': CVSSAttackComplexity.LOW,
                'privileges_required': CVSSPrivilegesRequired.LOW,
                'user_interaction': CVSSUserInteraction.REQUIRED,
                'scope': CVSSScope.UNCHANGED,
                'confidentiality': CVSSImpact.LOW,
                'integrity': CVSSImpact.LOW,
                'availability': CVSSImpact.NONE,
            },
            Severity.LOW: {
                'attack_vector': CVSSAttackVector.NETWORK,
                'attack_complexity': CVSSAttackComplexity.HIGH,
                'privileges_required': CVSSPrivilegesRequired.HIGH,
                'user_interaction': CVSSUserInteraction.REQUIRED,
                'scope': CVSSScope.UNCHANGED,
                'confidentiality': CVSSImpact.LOW,
                'integrity': CVSSImpact.NONE,
                'availability': CVSSImpact.NONE,
            },
        }
        
        if self.severity in defaults:
            metrics = defaults[self.severity]
            self.cvss_attack_vector = metrics['attack_vector']
            self.cvss_attack_complexity = metrics['attack_complexity']
            self.cvss_privileges_required = metrics['privileges_required']
            self.cvss_user_interaction = metrics['user_interaction']
            self.cvss_scope = metrics['scope']
            self.cvss_confidentiality = metrics['confidentiality']
            self.cvss_integrity = metrics['integrity']
            self.cvss_availability = metrics['availability']
            
            # Calculate score
            self.calculate_cvss_score()
    
    def calculate_cvss_score(self) -> Optional[float]:
        """
        Calculate CVSS v3.1 base score from individual metrics.
        Returns: CVSS score (0.0 - 10.0) or None if metrics incomplete.
        """
        # Check if all required metrics are present
        if not all([
            self.cvss_attack_vector,
            self.cvss_attack_complexity,
            self.cvss_privileges_required,
            self.cvss_user_interaction,
            self.cvss_scope,
            self.cvss_confidentiality,
            self.cvss_integrity,
            self.cvss_availability
        ]):
            return None
        
        # Metric value mappings
        av_values = {'N': 0.85, 'A': 0.62, 'L': 0.55, 'P': 0.2}
        ac_values = {'L': 0.77, 'H': 0.44}
        pr_values = {
            'unchanged': {'N': 0.85, 'L': 0.62, 'H': 0.27},
            'changed': {'N': 0.85, 'L': 0.68, 'H': 0.5}
        }
        ui_values = {'N': 0.85, 'R': 0.62}
        impact_values = {'H': 0.56, 'L': 0.22, 'N': 0.0}
        
        # Get values
        av = av_values[self.cvss_attack_vector.value]
        ac = ac_values[self.cvss_attack_complexity.value]
        scope_key = 'changed' if self.cvss_scope == CVSSScope.CHANGED else 'unchanged'
        pr = pr_values[scope_key][self.cvss_privileges_required.value]
        ui = ui_values[self.cvss_user_interaction.value]
        c = impact_values[self.cvss_confidentiality.value]
        i = impact_values[self.cvss_integrity.value]
        a = impact_values[self.cvss_availability.value]
        
        # Calculate Impact Sub-Score (ISS)
        iss = 1 - ((1 - c) * (1 - i) * (1 - a))
        
        # Calculate Impact
        if self.cvss_scope == CVSSScope.UNCHANGED:
            impact = 6.42 * iss
        else:
            impact = 7.52 * (iss - 0.029) - 3.25 * math.pow(iss - 0.02, 15)
        
        # Calculate Exploitability
        exploitability = 8.22 * av * ac * pr * ui
        
        # Calculate Base Score
        if impact <= 0:
            base_score = 0.0
        else:
            if self.cvss_scope == CVSSScope.UNCHANGED:
                base_score = min(impact + exploitability, 10.0)
            else:
                base_score = min(1.08 * (impact + exploitability), 10.0)
        
        # Round up to one decimal place
        base_score = math.ceil(base_score * 10) / 10
        
        # Update the score and vector
        self.cvss_score = base_score
        self.cvss_vector = self.generate_cvss_vector()
        
        return base_score
    
    def generate_cvss_vector(self) -> Optional[str]:
        """
        Generate CVSS v3.1 vector string.
        Example: "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H"
        """
        if not all([
            self.cvss_attack_vector,
            self.cvss_attack_complexity,
            self.cvss_privileges_required,
            self.cvss_user_interaction,
            self.cvss_scope,
            self.cvss_confidentiality,
            self.cvss_integrity,
            self.cvss_availability
        ]):
            return None
        
        return (
            f"CVSS:3.1/"
            f"AV:{self.cvss_attack_vector.value}/"
            f"AC:{self.cvss_attack_complexity.value}/"
            f"PR:{self.cvss_privileges_required.value}/"
            f"UI:{self.cvss_user_interaction.value}/"
            f"S:{self.cvss_scope.value}/"
            f"C:{self.cvss_confidentiality.value}/"
            f"I:{self.cvss_integrity.value}/"
            f"A:{self.cvss_availability.value}"
        )
    
    # ========================================================================
    # LIFECYCLE MANAGEMENT METHODS
    # ========================================================================
    
    def mark_false_positive(self, reason: str, marked_by: int) -> None:
        """Mark vulnerability as false positive."""
        self.is_false_positive = True
        self.false_positive_reason = reason
        self.false_positive_marked_by = marked_by
        self.status = VulnerabilityStatus.FALSE_POSITIVE
        self.action_required = False
        self.updated_at = datetime.utcnow()
    
    def verify(self, verified_by: int) -> None:
        """Verify vulnerability as genuine."""
        self.is_verified = True
        self.verified_by = verified_by
        self.verified_at = datetime.utcnow()
        self.status = VulnerabilityStatus.CONFIRMED
        self.updated_at = datetime.utcnow()
    
    def mark_fixed(self, fix_verified: bool = False) -> None:
        """Mark vulnerability as fixed."""
        self.is_fixed = True
        self.fix_verified = fix_verified
        self.fixed_at = datetime.utcnow()
        self.status = VulnerabilityStatus.FIXED
        self.action_required = False
        self.updated_at = datetime.utcnow()
    
    def suppress(self, reason: str, until: Optional[datetime] = None) -> None:
        """Suppress vulnerability reporting."""
        self.is_suppressed = True
        self.suppression_reason = reason
        self.suppressed_until = until
        self.action_required = False
        self.updated_at = datetime.utcnow()
    
    def unsuppress(self) -> None:
        """Remove suppression."""
        self.is_suppressed = False
        self.suppression_reason = None
        self.suppressed_until = None
        self.action_required = True
        self.updated_at = datetime.utcnow()
    
    def reopen(self) -> None:
        """Reopen a closed vulnerability."""
        self.status = VulnerabilityStatus.REOPENED
        self.is_fixed = False
        self.action_required = True
        self.updated_at = datetime.utcnow()
    
    def update_retest_status(self, status: str) -> None:
        """Update retest status."""
        self.retest_status = status
        self.retest_count += 1
        self.last_retest_at = datetime.utcnow()
        
        if status == "passed":
            self.mark_fixed(fix_verified=True)
        elif status == "failed":
            self.reopen()
    
    def soft_delete(self) -> None:
        """Soft delete the vulnerability."""
        self.deleted_at = datetime.utcnow()
    
    def restore(self) -> None:
        """Restore soft-deleted vulnerability."""
        self.deleted_at = None
    
    # ========================================================================
    # OWASP MAPPING METHODS
    # ========================================================================
    
    def auto_map_owasp_cwe(self) -> None:
        """Automatically populate OWASP category and CWE ID from vulnerability type."""
        self.owasp_category = self.vulnerability_type.owasp_2021_category
        self.cwe_id = self.vulnerability_type.cwe_id
    
    # ========================================================================
    # SERIALIZATION METHODS
    # ========================================================================
    
    def to_dict(self, include_sensitive: bool = True, include_relationships: bool = False) -> Dict[str, Any]:
        """
        Convert vulnerability to dictionary for API responses.
        
        Args:
            include_sensitive: Include sensitive fields like evidence, request_data
            include_relationships: Include related scan data
        
        Returns:
            Dictionary representation of the vulnerability
        """
        data = {
            "id": self.id,
            "type": self.vulnerability_type.value,
            "severity": self.severity.value,
            "severity_score": self.severity.score,
            "severity_color": self.severity.color,
            "status": self.status.value,
            
            # CVSS
            "cvss_score": self.cvss_score,
            "cvss_vector": self.cvss_vector,
            
            # Location
            "url": self.url,
            "parameter": self.parameter,
            "method": self.method,
            "endpoint": self.endpoint,
            
            # Details
            "title": self.title,
            "description": self.description,
            
            # Risk
            "likelihood": self.likelihood,
            "impact": self.impact,
            "exploitability": self.exploitability,
            "risk_level": self.risk_level,
            "priority_score": self.priority_score,
            
            # AI Analysis
            "ai_confidence": self.ai_confidence,
            "ai_analysis": self.ai_analysis,
            
            # Remediation
            "remediation": self.remediation,
            "remediation_effort": self.remediation_effort,
            "reference_links": self.reference_links,
            
            # OWASP & CWE
            "owasp_category": self.owasp_category,
            "cwe_id": self.cwe_id,
            "cwe_name": self.cwe_name,
            
            # Status flags
            "is_false_positive": self.is_false_positive,
            "is_verified": self.is_verified,
            "is_fixed": self.is_fixed,
            "is_suppressed": self.is_suppressed,
            "action_required": self.action_required,
            
            # Metadata
            "detected_by": self.detected_by,
            "detection_method": self.detection_method,
            "age_days": self.age_days,
            
            # Timestamps
            "detected_at": self.detected_at.isoformat() if self.detected_at else None,
            "verified_at": self.verified_at.isoformat() if self.verified_at else None,
            "fixed_at": self.fixed_at.isoformat() if self.fixed_at else None,
            "updated_at": self.updated_at.isoformat() if self.updated_at else None,
        }
        
        # Include sensitive data if requested
        if include_sensitive:
            data.update({
                "evidence": self.evidence,
                "payload_used": self.payload_used,
                "request_data": self.request_data,
                "response_snippet": self.response_snippet,
                "exploitability_rationale": self.exploitability_rationale,
                "scope_impact": self.scope_impact,
                "business_impact": self.business_impact,
            })
        
        # Include relationship data if requested
        if include_relationships and self.scan:
            data["scan"] = {
                "id": self.scan.id,
                "target_url": self.scan.target_url,
                "status": self.scan.status.value,
            }
        
        return data
    
    def __repr__(self):
        return f"<Vulnerability {self.id}: {self.title} ({self.severity.value})>"


# ============================================================================
# EVENT LISTENERS
# ============================================================================

@event.listens_for(Vulnerability, 'before_insert')
def auto_populate_owasp_cwe(mapper, connection, target):
    """Automatically populate OWASP and CWE fields on insert."""
    if target.vulnerability_type and not target.owasp_category:
        target.auto_map_owasp_cwe()


@event.listens_for(Vulnerability, 'before_update')
def update_timestamp(mapper, connection, target):
    """Ensure updated_at is always current."""
    target.updated_at = datetime.utcnow()